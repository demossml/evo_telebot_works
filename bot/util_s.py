from openpyxl import load_workbook
from openpyxl.utils import get_column_letter
import openpyxl
import traceback
import io
from numbers_parser import Document

from numbers_parser import Document
import traceback
import logging
from arrow import utcnow, get
from bd.model import Shop, AfsRequest, Employees, GetTime, Status


import logging

logger = logging.getLogger(__name__)


def format_message_list2(obj):
    text = ""  # –°–æ–∑–¥–∞–µ–º –ø—É—Å—Ç—É—é —Å—Ç—Ä–æ–∫—É, –≤ –∫–æ—Ç–æ—Ä—É—é –±—É–¥–µ–º –¥–æ–±–∞–≤–ª—è—Ç—å —Ç–µ–∫—Å—Ç
    messages = []  # –°–æ–∑–¥–∞–µ–º –ø—É—Å—Ç–æ–π —Å–ø–∏—Å–æ–∫ –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è —Å–æ–æ–±—â–µ–Ω–∏–π

    if len(obj) > 0:  # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –≤—Ö–æ–¥–Ω–æ–π –æ–±—ä–µ–∫—Ç –Ω–µ –ø—É—Å—Ç
        for k, v in obj.items():  # –ü—Ä–æ—Ö–æ–¥–∏–º –ø–æ –∫–ª—é—á–∞–º –∏ –∑–Ω–∞—á–µ–Ω–∏—è–º –≤ –æ–±—ä–µ–∫—Ç–µ
            key = str(k)  # –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –∫–ª—é—á –≤ —Å—Ç—Ä–æ–∫—É
            val = str(v)  # –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ –≤ —Å—Ç—Ä–æ–∫—É
            total_len = len(key) + len(val)  # –í—ã—á–∏—Å–ª—è–µ–º –æ–±—â—É—é –¥–ª–∏–Ω—É –∫–ª—é—á–∞ –∏ –∑–Ω–∞—á–µ–Ω–∏—è
            pad = 31 - total_len % 31  # –í—ã—á–∏—Å–ª—è–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø—Ä–æ–±–µ–ª–æ–≤ –¥–ª—è –≤—ã—Ä–∞–≤–Ω–∏–≤–∞–Ω–∏—è

            text += key  # –î–æ–±–∞–≤–ª—è–µ–º –∫–ª—é—á –≤ —Ç–µ–∫—Å—Ç

            if pad > 0:
                text += " " * pad  # –î–æ–±–∞–≤–ª—è–µ–º –ø—Ä–æ–±–µ–ª—ã –¥–ª—è –≤—ã—Ä–∞–≤–Ω–∏–≤–∞–Ω–∏—è

            if total_len > 31:
                text += " " * 2  # –î–æ–±–∞–≤–ª—è–µ–º –¥–≤–æ–π–Ω—ã–µ –ø—Ä–æ–±–µ–ª—ã, –µ—Å–ª–∏ –æ–±—â–∞—è –¥–ª–∏–Ω–∞ –±–æ–ª—å—à–µ 31

            text += str(v)  # –î–æ–±–∞–≤–ª—è–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ –≤ —Ç–µ–∫—Å—Ç
            text += "\n"  # –î–æ–±–∞–≤–ª—è–µ–º —Å–∏–º–≤–æ–ª –Ω–æ–≤–æ–π —Å—Ç—Ä–æ–∫–∏

        # –†–∞–∑–±–∏–≤–∞–µ–º —Ç–µ–∫—Å—Ç –Ω–∞ —á–∞—Å—Ç–∏, –µ—Å–ª–∏ –æ–Ω —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π
        index = 0
        size = 4000
        while len(text) > 0:
            part = text[index : index + size]  # –í—ã—Ä–µ–∑–∞–µ–º —á–∞—Å—Ç—å —Ç–µ–∫—Å—Ç–∞ –∑–∞–¥–∞–Ω–Ω–æ–≥–æ —Ä–∞–∑–º–µ—Ä–∞
            index = part.rfind("\n")  # –ù–∞—Ö–æ–¥–∏–º –ø–æ—Å–ª–µ–¥–Ω–∏–π —Å–∏–º–≤–æ–ª –Ω–æ–≤–æ–π —Å—Ç—Ä–æ–∫–∏ –≤ —á–∞—Å—Ç–∏
            if index == -1:
                index = len(
                    text
                )  # –ï—Å–ª–∏ —Å–∏–º–≤–æ–ª –Ω–æ–≤–æ–π —Å—Ç—Ä–æ–∫–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω, –∏—Å–ø–æ–ª—å–∑—É–µ–º –∫–æ–Ω–µ—Ü —Ç–µ–∫—Å—Ç–∞
            part = text[0:index]  # –í—ã–±–∏—Ä–∞–µ–º —á–∞—Å—Ç—å —Ç–µ–∫—Å—Ç–∞ –¥–æ —Å–∏–º–≤–æ–ª–∞ –Ω–æ–≤–æ–π —Å—Ç—Ä–æ–∫–∏
            messages.append(
                "```\n" + part + "\n```"
            )  # –î–æ–±–∞–≤–ª—è–µ–º —á–∞—Å—Ç—å —Ç–µ–∫—Å—Ç–∞ –≤ —Å–ø–∏—Å–æ–∫ —Å–æ–æ–±—â–µ–Ω–∏–π
            text = text[
                index:
            ].strip()  # –£–¥–∞–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—É—é —á–∞—Å—Ç—å –∏–∑ —Ç–µ–∫—Å—Ç–∞ –∏ —É–±–∏—Ä–∞–µ–º –ø—Ä–æ–±–µ–ª—ã

    return messages  # –í–æ–∑–≤—Ä–∞—â–∞–µ–º —Å–ø–∏—Å–æ–∫ —Å–æ–æ–±—â–µ–Ω–∏–π


def format_message_list4(obj):
    text = ""  # –°–æ–∑–¥–∞–µ–º –ø—É—Å—Ç—É—é —Å—Ç—Ä–æ–∫—É –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è —Ç–µ–∫—Å—Ç–∞ —Å–æ–æ–±—â–µ–Ω–∏–π.
    messages = []  # –°–æ–∑–¥–∞–µ–º –ø—É—Å—Ç–æ–π —Å–ø–∏—Å–æ–∫ –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –æ—Ç—Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π.

    if len(obj) > 0:  # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –æ–±—ä–µ–∫—Ç—ã –≤ —Å–ø–∏—Å–∫–µ.
        for i in obj:  # –ü—Ä–æ—Ö–æ–¥–∏–º –ø–æ –∫–∞–∂–¥–æ–º—É –æ–±—ä–µ–∫—Ç—É –≤ —Å–ø–∏—Å–∫–µ.
            for k, v in i.items():  # –ü—Ä–æ—Ö–æ–¥–∏–º –ø–æ –∫–∞–∂–¥–æ–π –ø–∞—Ä–µ –∫–ª—é—á-–∑–Ω–∞—á–µ–Ω–∏–µ –≤ –æ–±—ä–µ–∫—Ç–µ.
                key = str(k)  # –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –∫–ª—é—á –≤ —Å—Ç—Ä–æ–∫—É.
                val = str(v)  # –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ –≤ —Å—Ç—Ä–æ–∫—É.
                total_len = len(key) + len(
                    val
                )  # –í—ã—á–∏—Å–ª—è–µ–º –æ–±—â—É—é –¥–ª–∏–Ω—É –∫–ª—é—á–∞ –∏ –∑–Ω–∞—á–µ–Ω–∏—è.
                pad = (
                    30 - total_len % 30
                )  # –í—ã—á–∏—Å–ª—è–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø—Ä–æ–±–µ–ª–æ–≤, —á—Ç–æ–±—ã –≤—ã—Ä–æ–≤–Ω—è—Ç—å —Ç–µ–∫—Å—Ç.

                text += key  # –î–æ–±–∞–≤–ª—è–µ–º –∫–ª—é—á –∫ —Ç–µ–∫—Å—Ç—É.

                if pad > 0:  # –ï—Å–ª–∏ –Ω—É–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–±–µ–ª—ã –¥–ª—è –≤—ã—Ä–∞–≤–Ω–∏–≤–∞–Ω–∏—è,
                    text += " " * pad  # –¥–æ–±–∞–≤–ª—è–µ–º –∏—Ö.

                if total_len > 30:  # –ï—Å–ª–∏ –æ–±—â–∞—è –¥–ª–∏–Ω–∞ –ø—Ä–µ–≤—ã—à–∞–µ—Ç 30 —Å–∏–º–≤–æ–ª–æ–≤,
                    text += " " * 2  # –¥–æ–±–∞–≤–ª—è–µ–º 2 –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö –ø—Ä–æ–±–µ–ª–∞.

                text += str(v)  # –î–æ–±–∞–≤–ª—è–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ –∫ —Ç–µ–∫—Å—Ç—É.
                text += "\n"  # –î–æ–±–∞–≤–ª—è–µ–º –ø–µ—Ä–µ–≤–æ–¥ —Å—Ç—Ä–æ–∫–∏ –º–µ–∂–¥—É –∫–ª—é—á–∞–º–∏ –∏ –∑–Ω–∞—á–µ–Ω–∏—è–º–∏.
            text += "\n"  # –î–æ–±–∞–≤–ª—è–µ–º –ø—É—Å—Ç—É—é —Å—Ç—Ä–æ–∫—É –ø–æ—Å–ª–µ –∫–∞–∂–¥–æ–≥–æ –æ–±—ä–µ–∫—Ç–∞.
            text += "******************************"  # –î–æ–±–∞–≤–ª—è–µ–º —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª—å–Ω—É—é —Å—Ç—Ä–æ–∫—É.
            text += "\n"

        text += ""  # –ü—É—Å—Ç–∞—è —Å—Ç—Ä–æ–∫–∞ (—ç—Ç–æ –≤—ã–≥–ª—è–¥–∏—Ç –∫–∞–∫ –æ—à–∏–±–∫–∞, –ø–æ—Ç–æ–º—É —á—Ç–æ –æ–Ω–∞ –Ω–∏—á–µ–≥–æ –Ω–µ –¥–µ–ª–∞–µ—Ç).
        index = 0  # –ù–∞—á–∞–ª—å–Ω—ã–π –∏–Ω–¥–µ–∫—Å –¥–ª—è —Ä–∞–∑–¥–µ–ª–µ–Ω–∏—è —Ç–µ–∫—Å—Ç–∞ –Ω–∞ —á–∞—Å—Ç–∏.
        size = 4000  # –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –¥–ª–∏–Ω–∞ –∫–∞–∂–¥–æ–π —á–∞—Å—Ç–∏ —Å–æ–æ–±—â–µ–Ω–∏—è.
        while len(text) > 0:  # –ü–æ–∫–∞ –µ—Å—Ç—å —Ç–µ–∫—Å—Ç –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏:
            part = text[
                index : index + size
            ]  # –í—ã–±–∏—Ä–∞–µ–º —á–∞—Å—Ç—å —Ç–µ–∫—Å—Ç–∞ –¥–ª–∏–Ω–æ–π –Ω–µ –±–æ–ª–µ–µ 4000 —Å–∏–º–≤–æ–ª–æ–≤.
            index = part.rfind(
                "\n"
            )  # –ù–∞—Ö–æ–¥–∏–º –ø–æ—Å–ª–µ–¥–Ω–∏–π —Å–∏–º–≤–æ–ª –ø–µ—Ä–µ–≤–æ–¥–∞ —Å—Ç—Ä–æ–∫–∏ –≤ —á–∞—Å—Ç–∏.
            if index == -1:  # –ï—Å–ª–∏ —Å–∏–º–≤–æ–ª –ø–µ—Ä–µ–≤–æ–¥–∞ —Å—Ç—Ä–æ–∫–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω,
                index = len(text)  # –∏—Å–ø–æ–ª—å–∑—É–µ–º –≤—Å—é —á–∞—Å—Ç—å —Ç–µ–∫—Å—Ç–∞.
            part = text[
                0:index
            ]  # –í—ã–±–∏—Ä–∞–µ–º —á–∞—Å—Ç—å —Ç–µ–∫—Å—Ç–∞ –¥–æ –Ω–∞–π–¥–µ–Ω–Ω–æ–≥–æ —Å–∏–º–≤–æ–ª–∞ –ø–µ—Ä–µ–≤–æ–¥–∞ —Å—Ç—Ä–æ–∫–∏.
            messages.append(
                "```\n" + part + "\n```"
            )  # –î–æ–±–∞–≤–ª—è–µ–º —á–∞—Å—Ç—å —Ç–µ–∫—Å—Ç–∞ –≤ —Å–ø–∏—Å–æ–∫ —Å–æ–æ–±—â–µ–Ω–∏–π,
            text = text[index:].strip()  # –∏ —É–¥–∞–ª—è–µ–º –µ–µ –∏–∑ –∏—Å—Ö–æ–¥–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç–∞.

        return messages  # –í–æ–∑–≤—Ä–∞—â–∞–µ–º —Å–ø–∏—Å–æ–∫ –æ—Ç—Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π.


# –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ª–æ–≥–≥–µ—Ä–∞
logger = logging.getLogger(__name__)


def xls_to_json_format_change(downloaded_file, file_format):
    try:
        logger.info("–ù–∞—á–∞–ª–æ –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏—è —Ñ–∞–π–ª–∞ –≤ JSON")

        if file_format == ".xls" or file_format == ".xlsx":
            # –°–æ–∑–¥–∞–µ–º –±—É—Ñ–µ—Ä–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –æ–±—ä–µ–∫—Ç –¥–ª—è —á—Ç–µ–Ω–∏—è –∏–∑ –∑–∞–≥—Ä—É–∂–µ–Ω–Ω–æ–≥–æ —Ñ–∞–π–ª–∞
            file_buffer = io.BytesIO(downloaded_file)

            # –û—Ç–∫—Ä—ã–≤–∞–µ–º –∫–Ω–∏–≥—É Excel
            book = openpyxl.load_workbook(file_buffer)

            # –ü–æ–ª—É—á–∞–µ–º –∞–∫—Ç–∏–≤–Ω—ã–π –ª–∏—Å—Ç –∏–∑ –∫–Ω–∏–≥–∏ Excel
            ws = book.active

            my_list = []  # –°–æ–∑–¥–∞–µ–º –ø—É—Å—Ç–æ–π —Å–ø–∏—Å–æ–∫ –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è —Å–ª–æ–≤–∞—Ä–µ–π

            # –ù–∞—Ö–æ–¥–∏–º –Ω–æ–º–µ—Ä –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ —Å—Ç–æ–ª–±—Ü–∞ –∏ —Å—Ç—Ä–æ–∫–∏
            last_column = len(list(ws.columns))
            last_row = len(list(ws.rows))

            # –ü—Ä–æ—Ö–æ–¥–∏–º—Å—è –ø–æ –∫–∞–∂–¥–æ–π —Å—Ç—Ä–æ–∫–µ –≤ —Ç–∞–±–ª–∏—Ü–µ Excel
            for row in range(1, last_row + 1):
                my_dict = {}  # –°–æ–∑–¥–∞–µ–º –ø—É—Å—Ç–æ–π —Å–ª–æ–≤–∞—Ä—å –¥–ª—è —Ç–µ–∫—É—â–µ–π —Å—Ç—Ä–æ–∫–∏
                # –ü—Ä–æ—Ö–æ–¥–∏–º—Å—è –ø–æ –∫–∞–∂–¥–æ–º—É —Å—Ç–æ–ª–±—Ü—É –≤ —Ç–µ–∫—É—â–µ–π —Å—Ç—Ä–æ–∫–µ
                for column in range(1, last_column + 1):
                    column_letter = get_column_letter(
                        column
                    )  # –ü–æ–ª—É—á–∞–µ–º –±—É–∫–≤–µ–Ω–Ω–æ–µ –æ–±–æ–∑–Ω–∞—á–µ–Ω–∏–µ —Å—Ç–æ–ª–±—Ü–∞

                    if row > 1:  # –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –ø–µ—Ä–≤—É—é —Å—Ç—Ä–æ–∫—É, —Ç–∞–∫ –∫–∞–∫ —ç—Ç–æ –∑–∞–≥–æ–ª–æ–≤–∫–∏
                        # –î–æ–±–∞–≤–ª—è–µ–º —ç–ª–µ–º–µ–Ω—Ç—ã –≤ —Å–ª–æ–≤–∞—Ä—å –≤ —Ñ–æ—Ä–º–∞—Ç–µ "–∑–Ω–∞—á–µ–Ω–∏–µ –∑–∞–≥–æ–ª–æ–≤–∫–∞: –∑–Ω–∞—á–µ–Ω–∏–µ —è—á–µ–π–∫–∏"
                        header = str(
                            ws[column_letter + str(1)].value
                        ).strip()  # –£–±–∏—Ä–∞–µ–º –ø—Ä–æ–±–µ–ª—ã –≤ –∑–∞–≥–æ–ª–æ–≤–∫–∞—Ö
                        cell_value = ws[column_letter + str(row)].value
                        if isinstance(cell_value, str):
                            cell_value = (
                                cell_value.strip()
                            )  # –£–±–∏—Ä–∞–µ–º –ø—Ä–æ–±–µ–ª—ã –≤ –∑–Ω–∞—á–µ–Ω–∏—è—Ö
                        my_dict[header] = cell_value
                if len(my_dict) > 0:  # –£–±–µ–∂–¥–∞–µ–º—Å—è, —á—Ç–æ —Å–ª–æ–≤–∞—Ä—å –Ω–µ –ø—É—Å—Ç–æ–π
                    my_list.append(my_dict)  # –î–æ–±–∞–≤–ª—è–µ–º —Å–ª–æ–≤–∞—Ä—å –≤ —Å–ø–∏—Å–æ–∫

        elif file_format == ".numbers":
            # –°–æ–∑–¥–∞–µ–º –±—É—Ñ–µ—Ä–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –æ–±—ä–µ–∫—Ç –¥–ª—è —á—Ç–µ–Ω–∏—è –∏–∑ –∑–∞–≥—Ä—É–∂–µ–Ω–Ω–æ–≥–æ —Ñ–∞–π–ª–∞
            file_buffer = io.BytesIO(downloaded_file)

            # –û—Ç–∫—Ä—ã–≤–∞–µ–º –¥–æ–∫—É–º–µ–Ω—Ç .numbers
            doc = Document(file_buffer)
            sheets = doc.sheets()
            table = sheets[0].tables()[0]  # –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø–µ—Ä–≤—É—é —Ç–∞–±–ª–∏—Ü—É –≤ –ø–µ—Ä–≤–æ–º –ª–∏—Å—Ç–µ

            my_list = []  # –°–æ–∑–¥–∞–µ–º –ø—É—Å—Ç–æ–π —Å–ø–∏—Å–æ–∫ –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è —Å–ª–æ–≤–∞—Ä–µ–π

            # –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ —Ç–∞–±–ª–∏—Ü—ã
            rows = table.rows()
            headers = rows[0]  # –ü–µ—Ä–≤–∞—è —Å—Ç—Ä–æ–∫–∞ - –∑–∞–≥–æ–ª–æ–≤–∫–∏

            # –ü—Ä–æ—Ö–æ–¥–∏–º—Å—è –ø–æ –∫–∞–∂–¥–æ–π —Å—Ç—Ä–æ–∫–µ –≤ —Ç–∞–±–ª–∏—Ü–µ .numbers
            for row in rows[1:]:  # –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –ø–µ—Ä–≤—É—é —Å—Ç—Ä–æ–∫—É —Å –∑–∞–≥–æ–ª–æ–≤–∫–∞–º–∏
                my_dict = {}  # –°–æ–∑–¥–∞–µ–º –ø—É—Å—Ç–æ–π —Å–ª–æ–≤–∞—Ä—å –¥–ª—è —Ç–µ–∫—É—â–µ–π —Å—Ç—Ä–æ–∫–∏
                for header, cell in zip(headers, row):
                    header = header.strip()  # –£–±–∏—Ä–∞–µ–º –ø—Ä–æ–±–µ–ª—ã –≤ –∑–∞–≥–æ–ª–æ–≤–∫–∞—Ö
                    cell_value = cell.value
                    if isinstance(cell_value, str):
                        cell_value = cell_value.strip()  # –£–±–∏—Ä–∞–µ–º –ø—Ä–æ–±–µ–ª—ã –≤ –∑–Ω–∞—á–µ–Ω–∏—è—Ö
                    my_dict[header] = cell_value
                if len(my_dict) > 0:  # –£–±–µ–∂–¥–∞–µ–º—Å—è, —á—Ç–æ —Å–ª–æ–≤–∞—Ä—å –Ω–µ –ø—É—Å—Ç–æ–π
                    my_list.append(my_dict)  # –î–æ–±–∞–≤–ª—è–µ–º —Å–ª–æ–≤–∞—Ä—å –≤ —Å–ø–∏—Å–æ–∫

        logger.info("–ü—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ")
        return my_list  # –í–æ–∑–≤—Ä–∞—â–∞–µ–º —Å–ø–∏—Å–æ–∫ —Å–ª–æ–≤–∞—Ä–µ–π

    except openpyxl.utils.exceptions.InvalidFileException:
        logger.error("–ó–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–π —Ñ–∞–π–ª –Ω–µ —è–≤–ª—è–µ—Ç—Å—è –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω—ã–º —Ñ–∞–π–ª–æ–º Excel.")
        return None
    except Exception as e:
        logger.error(f"–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞: {e}")
        traceback.print_exc()
        return None


def status_shop(shop_id: str) -> bool:
    # –ü–æ–ª—É—á–∞–µ–º –æ–±—ä–µ–∫—Ç —Å—Ç–∞—Ç—É—Å–∞ –∏–∑ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —É–∫–∞–∑–∞–Ω–Ω–æ–≥–æ –º–∞–≥–∞–∑–∏–Ω–∞ —Å–æ —Å—Ç–∞—Ç—É—Å–æ–º "deleted"
    doc_status = Status.objects(shop=shop_id, status="deleted").first()
    # –í–æ–∑–≤—Ä–∞—â–∞–µ–º True, –µ—Å–ª–∏ –æ–±—ä–µ–∫—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω –∏–ª–∏ –µ–≥–æ —Å—Ç–∞—Ç—É—Å "restore", –∏–Ω–∞—á–µ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º False
    return not (doc_status and doc_status.status != "restore")


# # –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π –ø–æ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—é
def send_scheduled_message():
    since = utcnow().replace(hour=2).isoformat()

    result = {}
    for shop in Shop.objects():
        if status_shop(shop["uuid"]):
            documents = GetTime.objects(
                __raw__={"openingData": {"$gte": since}, "shopUuid": shop["uuid"]}
            )

            result[shop["name"]] = "–ï–©–ï –ù–ï –û–¢–ö–†–´–¢–ê!!!"

            for doc in documents:
                user_id = str(doc.user_id)
                employees = [
                    element["name"]
                    for element in Employees.objects(lastName=user_id).only("name")
                ]
                if doc["openingData"]:
                    result[shop["name"]] = "{} {}".format(
                        employees[0], doc["openingData"][11:16]
                    )
    return [result]


# Define the welcome message
welcome_message = """
–ü—Ä–∏–≤–µ—Ç! üëã –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ –Ω–∞—à –±–æ—Ç –¥–ª—è –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è –∞–Ω–∫–µ—Ç—ã. 
–Ø –ø–æ–º–æ–≥—É –≤–∞–º –∑–∞–ø–æ–ª–Ω–∏—Ç—å –≤—Å—é –Ω–µ–æ–±—Ö–æ–¥–∏–º—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é. –í–æ—Ç —Å–ø–∏—Å–æ–∫ –¥–∞–Ω–Ω—ã—Ö, –∫–æ—Ç–æ—Ä—ã–µ –Ω—É–∂–Ω–æ –±—É–¥–µ—Ç —É–∫–∞–∑–∞—Ç—å:

1. **–§–∞–º–∏–ª–∏—è –ò–º—è –û—Ç—á–µ—Å—Ç–≤–æ** - –ù–∞–ø–∏—à–∏—Ç–µ –§–∞–º–∏–ª–∏—è –ò–º—è –û—Ç—á–µ—Å—Ç–≤–æ ‚úçÔ∏è
2. **–î–∞—Ç–∞ —Ä–æ–∂–¥–µ–Ω–∏—è** - –ù–∞–ø–∏—à–∏—Ç–µ –¥–∞—Ç—É —Ä–æ–∂–¥–µ–Ω–∏—è –≤ —Ñ–æ—Ä–º–∞—Ç–µ –î–î.–ú–ú.–ì–ì–ì–ì ‚úçÔ∏è
3. **–ì—Ä–∞–∂–¥–∞–Ω—Å—Ç–≤–æ** - –ù–∞–ø–∏—à–∏—Ç–µ –≥—Ä–∞–∂–¥–∞–Ω—Å—Ç–≤–æ ‚úçÔ∏è
4. **–ú–µ—Å—Ç–æ —Ä–æ–∂–¥–µ–Ω–∏—è** - –ù–∞–ø–∏—à–∏—Ç–µ –º–µ—Å—Ç–æ —Ä–æ–∂–¥–µ–Ω–∏—è ‚úçÔ∏è
5. **–ê–¥—Ä–µ—Å (–º–µ—Å—Ç–æ –∂–∏—Ç–µ–ª—å—Å—Ç–≤–∞)** - –ù–∞–ø–∏—à–∏—Ç–µ –∞–¥—Ä–µ—Å (–º–µ—Å—Ç–æ –∂–∏—Ç–µ–ª—å—Å—Ç–≤–∞) ‚úçÔ∏è
6. **–ù–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞** - –ù–∞–ø–∏—à–∏—Ç–µ –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞ ‚úçÔ∏è
7. **–°–µ–º–µ–π–Ω–æ–µ –ø–æ–ª–æ–∂–µ–Ω–∏–µ** - –í—ã–±–µ—Ä–∏—Ç–µ —Å–µ–º–µ–π–Ω–æ–µ –ø–æ–ª–æ–∂–µ–Ω–∏–µ üë´
8. **–ú–µ—Å—Ç–æ —Ä–∞–±–æ—Ç—ã –∏ –¥–æ–ª–∂–Ω–æ—Å—Ç—å (–¥–ª—è —Ä–æ–¥—Å—Ç–≤–µ–Ω–Ω–∏–∫–æ–≤)** - –ù–∞–ø–∏—à–∏—Ç–µ –º–µ—Å—Ç–æ —Ä–∞–±–æ—Ç—ã, –¥–æ–ª–∂–Ω–æ—Å—Ç—å ‚úçÔ∏è
9. **–ù–∞–≤—ã–∫–∏** - –ù–∞–ø–∏—à–∏—Ç–µ —Å–≤–æ–∏ –Ω–∞–≤—ã–∫–∏ (–Ω–∞–≤—ã–∫–∏ –≤–ª–∞–¥–µ–Ω–∏—è –∫–æ–º–ø—å—é—Ç–µ—Ä–æ–º, –∑–Ω–∞–Ω–∏–µ –∏–Ω–æ—Å—Ç—Ä–∞–Ω–Ω—ã—Ö —è–∑—ã–∫–æ–≤ –∏ —Ç.–¥.) ‚úçÔ∏è
10. **–†–µ–∫–æ–º–µ–Ω–¥–∞—Ç–µ–ª–∏** - –ù–∞–ø–∏—à–∏—Ç–µ –¥–æ–ª–∂–Ω–æ—Å—Ç—å, –§.–ò.–û. –∏ –∫–æ–Ω—Ç–∞–∫—Ç–Ω—ã–π —Ç–µ–ª–µ—Ñ–æ–Ω —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ç–µ–ª—è ‚úçÔ∏è
11. **–û–ø—ã—Ç —Ä–∞–±–æ—Ç—ã** - –£–∫–∞–∂–∏—Ç–µ –¥–∞—Ç—ã –Ω–∞—á–∞–ª–∞ –∏ –æ–∫–æ–Ω—á–∞–Ω–∏—è, –Ω–∞–∑–≤–∞–Ω–∏–µ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏, –¥–æ–ª–∂–Ω–æ—Å—Ç—å –∏ –ø—Ä–∏—á–∏–Ω—É —É–≤–æ–ª—å–Ω–µ–Ω–∏—è ‚úçÔ∏è
12. **–û–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ** - –£–∫–∞–∂–∏—Ç–µ –¥–∞—Ç—ã –ø–æ—Å—Ç—É–ø–ª–µ–Ω–∏—è –∏ –æ–∫–æ–Ω—á–∞–Ω–∏—è, –Ω–∞–∑–≤–∞–Ω–∏–µ —É—á–µ–±–Ω–æ–≥–æ –∑–∞–≤–µ–¥–µ–Ω–∏—è –∏ —Å–ø–µ—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—é ‚úçÔ∏è
13. **–í–∞—à–∏ —Ö–æ–±–±–∏** - –ù–∞–ø–∏—à–∏—Ç–µ –≤–∞—à–∏ —Ö–æ–±–±–∏ ‚úçÔ∏è
14. **–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è** - –ù–∞–ø–∏—à–∏—Ç–µ –∫–∞–∫—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –≤—ã —Ö–æ—Ç–µ–ª–∏ –±—ã –¥–æ–±–∞–≤–∏—Ç—å –æ —Å–µ–±–µ ‚úçÔ∏è

–ü–æ–µ—Ö–∞–ª–∏! üöÄ
"""
